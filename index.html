<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steal a Lobo - Sistema Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #2d1b69 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #FFD700, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-tab.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .multiplayer-notice {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #FF6B35, #F44336);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
            animation: pulse 2s infinite;
            text-align: center;
            max-width: 90%;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .game-container {
            display: grid;
            grid-template-areas: 
                "header header header header header header header"
                "controls conveyor shop inventory players bases trading"
                "defense conveyor shop inventory players bases trading";
            grid-template-columns: 250px 1fr 300px 350px 250px 300px 250px;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            padding: 15px;
            min-height: 100vh;
            margin-top: 50px;
        }

        .header {
            grid-area: header;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FF6B35, #9C27B0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .player-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .money-display {
            font-size: 1.8rem;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .income-display {
            font-size: 1rem;
            color: #81C784;
        }

        .controls, .defense-area, .inventory-area, .shop-area, .players-area, .trading-area, .bases-area {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .controls {
            grid-area: controls;
        }

        .conveyor-belt {
            grid-area: conveyor;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            overflow: hidden;
            position: relative;
        }

        .shop-area {
            grid-area: shop;
            overflow-y: auto;
            max-height: 600px;
        }

        .inventory-area {
            grid-area: inventory;
            overflow-y: auto;
            max-height: 600px;
        }

        .players-area {
            grid-area: players;
            overflow-y: auto;
            max-height: 600px;
        }

        .trading-area {
            grid-area: trading;
            overflow-y: auto;
            max-height: 600px;
        }

        .bases-area {
            grid-area: bases;
            overflow-y: auto;
            max-height: 600px;
        }

        .defense-area {
            grid-area: defense;
        }

        .belt-container {
            height: 100%;
            overflow: hidden;
            position: relative;
            background: linear-gradient(90deg, #333 0%, #555 50%, #333 100%);
            border-radius: 10px;
            border: 3px solid #666;
        }

        .belt-items {
            display: flex;
            animation: beltMove 50s linear infinite;
            height: 100%;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
        }

        @keyframes beltMove {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .belt-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            font-size: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            position: relative;
        }

        .belt-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: #FFD700;
            text-align: center;
        }

        .action-button {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            font-size: 0.9rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .collect-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .steal-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .defense-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .attack-btn {
            background: linear-gradient(45deg, #FF5722, #E64A19);
            color: white;
        }

        .shop-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .trade-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .inventory-item:hover {
            transform: scale(1.05);
        }

        .inventory-item.selected {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }

        .inventory-item.in-trade {
            border-color: #FF9800;
            background: rgba(255, 152, 0, 0.2);
        }

        .item-name {
            font-size: 0.6rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .item-income {
            font-size: 0.5rem;
            color: #4CAF50;
        }

        .item-count {
            position: absolute;
            top: -3px;
            right: -3px;
            background: #FF5722;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Rarities */
        .comum { border-color: #888; }
        .incomum { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .raro { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); }
        .epico { border-color: #9C27B0; background: rgba(156, 39, 176, 0.1); }
        .lendario { border-color: #FF9800; background: rgba(255, 152, 0, 0.1); }
        .mitico { border-color: #F44336; background: rgba(244, 67, 54, 0.1); }
        .prismatico { 
            border: 2px solid #FFD700;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 105, 180, 0.2));
            animation: prismaticGlow 2s ease-in-out infinite alternate;
        }

        @keyframes prismaticGlow {
            0% { box-shadow: 0 0 10px #FFD700; }
            100% { box-shadow: 0 0 20px #FF69B4; }
        }

        .crate-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .crate-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .crate-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .crate-price {
            color: #4CAF50;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .crate-description {
            font-size: 0.8rem;
            color: #ccc;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-name {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .player-stats {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .trading-status {
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .trading-status.active {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #FF9800;
            color: #FF9800;
        }

        .trading-status.inactive {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            color: #4CAF50;
        }

        .trade-offer {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            max-width: 280px;
            font-size: 0.9rem;
        }

        .notification.success { background: #4CAF50; color: white; }
        .notification.failure { background: #f44336; color: white; }
        .notification.warning { background: #FF9800; color: white; }
        .notification.info { background: #2196F3; color: white; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1rem;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #ccc;
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .trade-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .trade-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .trade-header h3 {
            margin: 0;
            color: #FFD700;
            font-size: 1.5rem;
        }

        .close-trade {
            background: none;
            border: none;
            color: #f44336;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .close-trade:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        .trade-players {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin: 20px 0;
            align-items: start;
        }

        .trade-player {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .trade-player-name {
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .trade-items {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trade-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.8rem;
            text-align: center;
        }

        .trade-empty {
            color: #ccc;
            font-style: italic;
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
        }

        .trade-vs {
            font-size: 2rem;
            color: #FF9800;
            text-align: center;
            align-self: center;
            animation: pulse 2s infinite;
        }

        .trade-status {
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
            color: #2196F3;
            font-weight: bold;
        }

        .trade-status.confirmed {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .trade-status.waiting {
            background: rgba(255, 152, 0, 0.2);
            border-color: #FF9800;
            color: #FF9800;
        }

        .trade-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .trade-actions .action-button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
        }

        .trade-inventory {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .trade-inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.6rem;
            position: relative;
        }

        .trade-inventory-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .trade-inventory-item .item-count {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #FF5722;
            color: white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            font-size: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .base-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .base-locked {
            border-color: #FF5722;
            background: rgba(255, 87, 34, 0.1);
        }

        .base-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .base-name {
            font-weight: bold;
            color: #FFD700;
        }

        .base-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .base-status.locked {
            background: #FF5722;
            color: white;
        }

        .base-status.unlocked {
            background: #4CAF50;
            color: white;
        }

        .base-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 4px;
            margin: 8px 0;
            max-height: 80px;
            overflow-y: auto;
        }

        .base-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            font-size: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .base-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .lock-btn {
            background: linear-gradient(45deg, #FF5722, #E64A19);
            color: white;
        }

        .raid-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .minigame-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .minigame-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .minigame-title {
            font-size: 1.5rem;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .minigame-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .minigame-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .minigame-button:hover {
            transform: scale(1.1);
        }

        .minigame-button.active {
            background: linear-gradient(45d, #FF9800, #F57C00);
            animation: pulse 0.5s ease-in-out;
        }

        .minigame-progress {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .minigame-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .belt-item-price {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4CAF50;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .belt-item.sold-out {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
        }

        .belt-item.sold-out .belt-item-price {
            background: #f44336;
        }

        @media (max-width: 1800px) {
            .game-container {
                grid-template-areas: 
                    "header"
                    "controls"
                    "conveyor"
                    "shop"
                    "inventory"
                    "players"
                    "bases"
                    "trading"
                    "defense";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto auto auto auto auto;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <h2 class="login-title">🎮 Character Tycoon</h2>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('login')">Entrar</button>
                <button class="login-tab" onclick="switchTab('register')">Criar Conta</button>
            </div>

            <div id="loginTab">
                <input type="text" class="login-input" id="loginUsername" placeholder="Nome de usuário">
                <input type="password" class="login-input" id="loginPassword" placeholder="Senha">
                <input type="text" class="login-input" id="loginRoomCode" placeholder="Código da Sala (ex: SALA123)" maxlength="20">
                <button class="login-btn" onclick="loginUser()">🚀 Entrar</button>
            </div>

            <div id="registerTab" style="display: none;">
                <input type="text" class="login-input" id="registerUsername" placeholder="Nome de usuário" maxlength="15">
                <input type="password" class="login-input" id="registerPassword" placeholder="Senha">
                <input type="password" class="login-input" id="confirmPassword" placeholder="Confirmar senha">
                <button class="login-btn" onclick="registerUser()">📝 Criar Conta</button>
            </div>

            <div style="margin-top: 15px; font-size: 0.8rem; color: #ccc;">
                <strong>Sistema completo com:</strong><br>
                🎒 Inventário persistente<br>
                🔄 Sistema de trocas<br>
                📦 Loja com crates<br>
                👥 Multiplayer real
            </div>
            
            <button class="login-btn" onclick="testSystem()" style="background: linear-gradient(45deg, #2196F3, #1976D2); margin-top: 10px;">
                🔧 Testar Sistema
            </button>
        </div>
    </div>

    <div class="multiplayer-notice">
        🌐 SISTEMA COMPLETO - Inventário, Trocas e Crates!
    </div>

    <!-- Minigame Modal -->
    <div class="minigame-modal" id="minigameModal" style="display: none;">
        <div class="minigame-content">
            <div class="minigame-title" id="minigameTitle">🎯 Hackear Base</div>
            <div id="minigameInstructions">Clique no botão quando ele ficar laranja!</div>
            
            <div class="minigame-area">
                <button class="minigame-button" id="minigameButton" onclick="minigameClick()">
                    🎯
                </button>
                <div id="minigameTimer">Prepare-se...</div>
            </div>
            
            <div class="minigame-progress">
                <div class="minigame-progress-bar" id="minigameProgress"></div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="action-button" style="background: #f44336; flex: 1;" onclick="cancelMinigame()">
                    ❌ Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="minigame-modal" id="adminPanel" style="display: none;">
        <div class="minigame-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="minigame-title">👑 PAINEL DE ADMINISTRADOR</div>
            <div style="color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 0.9rem;">
                🔥 ACESSO TOTAL DESBLOQUEADO 🔥
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #4CAF50; margin-bottom: 10px;">💰 Dinheiro</h4>
                    <input type="number" id="adminMoney" placeholder="Quantidade" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 5px; background: rgba(255,255,255,0.2); color: white;">
                    <button class="action-button" style="background: #4CAF50; font-size: 0.8rem; padding: 8px;" onclick="adminGiveMoney()">
                        Dar Dinheiro
                    </button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #FF9800; margin-bottom: 10px;">🎭 Personagens</h4>
                    <select id="adminCharacter" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 5px; background: rgba(255,255,255,0.2); color: black;">
                        <option value="">Selecionar personagem...</option>
                    </select>
                    <button class="action-button" style="background: #FF9800; font-size: 0.8rem; padding: 8px;" onclick="adminSpawnCharacter()">
                        Spawnar Personagem
                    </button>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                <h4 style="color: #9C27B0; margin-bottom: 10px;">🎯 Jogadores Online</h4>
                <div id="adminPlayersList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Players will be populated here -->
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="action-button" style="background: #2196F3; flex: 1;" onclick="adminRefreshBelt()">
                    🔄 Nova Esteira
                </button>
                <button class="action-button" style="background: #f44336; flex: 1;" onclick="closeAdminPanel()">
                    ❌ Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div class="trade-modal" id="tradeModal" style="display: none;">
        <div class="trade-modal-content">
            <div class="trade-header">
                <h3>🔄 Troca em Andamento</h3>
                <button class="close-trade" onclick="cancelTrade()">❌</button>
            </div>
            
            <div class="trade-players">
                <div class="trade-player">
                    <div class="trade-player-name">Você</div>
                    <div class="trade-items" id="yourTradeItems">
                        <div class="trade-empty">Nenhum item oferecido</div>
                    </div>
                </div>
                
                <div class="trade-vs">⚡</div>
                
                <div class="trade-player">
                    <div class="trade-player-name" id="partnerName">Parceiro</div>
                    <div class="trade-items" id="partnerTradeItems">
                        <div class="trade-empty">Aguardando oferta...</div>
                    </div>
                </div>
            </div>
            
            <div class="trade-status" id="tradeStatus">
                Aguardando confirmação dos jogadores...
            </div>
            
            <div class="trade-actions">
                <button class="action-button" style="background: #4CAF50;" onclick="confirmTrade()" id="confirmTradeBtn">
                    ✅ Confirmar Troca
                </button>
                <button class="action-button" style="background: #f44336;" onclick="cancelTrade()">
                    ❌ Cancelar
                </button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="header">
            <h1 class="game-title">🏰 Character Tycoon Complete</h1>
            <div class="player-info">
                <span>👤 <span id="currentPlayer">-</span></span>
                <span>🏠 Sala: <span id="currentRoom">-</span></span>
                <span>👥 Online: <span id="onlineCount">0</span></span>
            </div>
            <div class="money-display">💰 Dinheiro: $<span id="money">100</span></div>
            <div class="income-display">📈 Renda: $<span id="income">0</span>/seg | 🛡️ Defesa: <span id="defenseLevel">0</span>%</div>
        </div>

        <div class="controls">
            <h2 class="section-title">🎮 Ações</h2>
            
            <div class="connection-status connected" id="connectionStatus">
                🟢 Sistema carregado!
            </div>
            
            <button class="action-button collect-btn" onclick="collectFromBelt()">
                🎯 Coletar da Esteira
            </button>
            
            <button class="action-button attack-btn" onclick="attackRandomPlayer()">
                ⚔️ Atacar Jogador
            </button>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="totalItems">0</div>
                    <div class="stat-label">Itens Únicos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="totalValue">0</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>
        </div>

        <div class="conveyor-belt">
            <h2 class="section-title">🏭 Esteira Aleatória</h2>
            <div class="belt-container">
                <div class="belt-items" id="beltItems">
                    <!-- Characters will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="shop-area">
            <h2 class="section-title">🛒 Loja de Crates</h2>
            <div id="shopItems">
                <div class="crate-item comum" onclick="buyCrate('basic')">
                    <div class="crate-name">📦 Crate Básico</div>
                    <div class="crate-price">$200</div>
                    <div class="crate-description">Comum a Raro<br>85% Comum, 15% Raro</div>
                </div>
                
                <div class="crate-item epico" onclick="buyCrate('premium')">
                    <div class="crate-name">💎 Crate Premium</div>
                    <div class="crate-price">$800</div>
                    <div class="crate-description">Raro a Épico<br>60% Raro, 40% Épico</div>
                </div>
                
                <div class="crate-item lendario" onclick="buyCrate('legendary')">
                    <div class="crate-name">🌟 Crate Lendário</div>
                    <div class="crate-price">$2500</div>
                    <div class="crate-description">Épico a Lendário<br>70% Épico, 30% Lendário</div>
                </div>
                
                <div class="crate-item prismatico" onclick="buyCrate('mythic')">
                    <div class="crate-name">🔮 Crate Mítico</div>
                    <div class="crate-price">$8000</div>
                    <div class="crate-description">Lendário a Prismático<br>80% Lendário, 15% Mítico, 5% Prismático</div>
                </div>
            </div>
        </div>

        <div class="inventory-area">
            <h2 class="section-title">🎒 Meu Inventário</h2>
            <div class="inventory-grid" id="inventoryGrid">
                <div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">
                    Inventário vazio. Compre crates ou colete da esteira!
                </div>
            </div>
        </div>

        <div class="players-area">
            <h2 class="section-title">👥 Jogadores Online</h2>
            <div id="playersList">
                <div style="text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">
                    Carregando jogadores...
                </div>
            </div>
        </div>

        <div class="bases-area">
            <h2 class="section-title">🏠 Bases dos Jogadores</h2>
            
            <div class="base-card">
                <div class="base-header">
                    <div class="base-name">🏠 Sua Base</div>
                    <div class="base-status unlocked" id="myBaseStatus">Desbloqueada</div>
                </div>
                <div class="base-items" id="myBaseItems">
                    <div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 10px; font-size: 0.7rem;">
                        Base vazia
                    </div>
                </div>
                <div class="base-actions">
                    <button class="action-button lock-btn" style="font-size: 0.7rem; padding: 6px; flex: 1;" 
                            onclick="lockMyBase()" id="lockBaseBtn">
                        🔒 Trancar (60s)
                    </button>
                </div>
            </div>
            
            <div id="otherBases">
                <div style="text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">
                    Carregando bases...
                </div>
            </div>
        </div>

        <div class="trading-area">
            <h2 class="section-title">🔄 Sistema de Trocas</h2>
            
            <div class="trading-status inactive" id="tradingStatus">
                🟢 Disponível para trocas
            </div>
            
            <div id="selectedItems" style="margin: 10px 0;">
                <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 5px;">Itens selecionados:</div>
                <div id="selectedItemsList" style="font-size: 0.7rem; color: #FFD700;">Nenhum item selecionado</div>
            </div>
            
            <button class="action-button trade-btn" onclick="tradeWithBot()" id="tradeBotBtn">
                🤖 Trocar com Bot
            </button>
            
            <div id="tradeOffers">
                <!-- Trade offers will appear here -->
            </div>
        </div>

        <div class="defense-area">
            <h2 class="section-title">🛡️ Defesa</h2>
            
            <div class="stat-box" style="margin: 10px 0;">
                <div>Nível: <span id="defenseDisplayLevel">0</span></div>
                <div>Proteção: <span id="defensePercentage">0</span>%</div>
            </div>
            
            <button class="action-button defense-btn" id="defenseUpgrade" onclick="upgradeDefense()">
                🔒 Melhorar ($<span id="defenseCost">300</span>)
            </button>
            
            <button class="action-button" style="background: linear-gradient(45deg, #9C27B0, #7B1FA2); margin-top: 10px;" 
                    onclick="startAdminChallenge()" id="adminChallengeBtn">
                👑 Desafio Admin (<span id="adminWins">0</span>/3)
            </button>
        </div>
    </div>

    <script>
        let gameState = {
            money: 100,
            income: 0,
            inventory: {},
            base: {},
            baseLocked: false,
            baseLockTime: 0,
            defenseCost: 300,
            defenseLevel: 0,
            selectedItems: [],
            inTrade: false,
            currentTradeOffer: null,
            tradePartner: null
        };

        let userAccount = {
            username: '',
            userId: '',
            roomCode: ''
        };

        let multiplayerState = {
            roomCode: '',
            playerId: '',
            lastUpdate: Date.now()
        };

        let roomPlayers = {};
        let connectionInterval;
        
        // Minigame variables
        let minigameActive = false;
        let minigameTarget = null;
        let minigameProgress = 0;
        let minigameTimer = null;
        let minigameRound = 0;
        let minigameSuccess = 0;

        // Admin system
        let adminState = {
            isAdmin: false,
            adminWins: 0,
            adminChallengeActive: false,
            adminChallengeRound: 0,
            adminChallengeSuccess: 0,
            adminChallengeTimer: null
        };

        // Fixed character rarities
        const characterDatabase = {
            // Prismáticos (como solicitado)
            "Lá grande Combinação": { rarity: 'prismatico', income: 500 },
            "Los combinações": { rarity: 'prismatico', income: 450 },
            "Lá suprema combinação": { rarity: 'prismatico', income: 600 },
            
            // Míticos
            "Matteo": { rarity: 'mitico', income: 200 },
            "Centralucci Nuclearucci": { rarity: 'mitico', income: 180 },
            "Chef Crabracadabra": { rarity: 'mitico', income: 160 },
            
            // Lendários
            "Bombardiro Cocodrilo": { rarity: 'lendario', income: 80 },
            "Capuccino Asesino": { rarity: 'lendario', income: 75 },
            "Glorbo Fruttodrillo": { rarity: 'lendario', income: 70 },
            "Rhinodino Dildorino": { rarity: 'lendario', income: 65 },
            
            // Épicos
            "Tung Tung Tung Sahur": { rarity: 'epico', income: 35 },
            "Bailarina Cappuccina": { rarity: 'epico', income: 32 },
            "Shpioniro Golubiro": { rarity: 'epico', income: 30 },
            "La Vaca Saturno Saturnita": { rarity: 'epico', income: 28 },
            "Bombardiere Lucertola": { rarity: 'epico', income: 25 },
            
            // Raros
            "Chimpanzini Bananini": { rarity: 'raro', income: 18 },
            "Bombombini Gusini": { rarity: 'raro', income: 16 },
            "Boneca Ambalabu": { rarity: 'raro', income: 15 },
            "Bobrito Bandito": { rarity: 'raro', income: 14 },
            "Burbaloni Lulilolli": { rarity: 'raro', income: 12 },
            
            // Incomuns
            "Tripi Tripo": { rarity: 'incomum', income: 8 },
            "Brr Brr Patapim": { rarity: 'incomum', income: 7 },
            "Frigo Camelo": { rarity: 'incomum', income: 6 },
            "Blueberrinni Octopussini": { rarity: 'incomum', income: 5 },
            
            // Comuns
            "Tralalero Tralala": { rarity: 'comum', income: 3 },
            "Lirilì Larilà": { rarity: 'comum', income: 2 },
            "Hipocactus": { rarity: 'comum', income: 2 },
            "Trippi Troppi": { rarity: 'comum', income: 2 },
            "Fruli Frula": { rarity: 'comum', income: 1 },
            "Pot Hotspot": { rarity: 'comum', income: 1 },
            "Brri Brri Bicus Dicus Bombicus": { rarity: 'comum', income: 1 },
            "Talpa Di Ferro": { rarity: 'comum', income: 1 },
            "Svinino Bombondino": { rarity: 'comum', income: 1 },
            "Tric Trac Baraboom": { rarity: 'comum', income: 1 },
            "Orangutini Ananasini": { rarity: 'comum', income: 1 },
            "Espressona Señora": { rarity: 'comum', income: 1 },
            "Zibra Zubra Zibralini": { rarity: 'comum', income: 1 },
            "Graipussi Medussi": { rarity: 'comum', income: 1 },
            "Tigrrullini Watermellini": { rarity: 'comum', income: 1 }
        };

        const characterList = Object.keys(characterDatabase);

        const crateTypes = {
            basic: {
                price: 200,
                rarities: [
                    { rarity: 'comum', chance: 0.85 },
                    { rarity: 'incomum', chance: 0.15 }
                ]
            },
            premium: {
                price: 800,
                rarities: [
                    { rarity: 'raro', chance: 0.60 },
                    { rarity: 'epico', chance: 0.40 }
                ]
            },
            legendary: {
                price: 2500,
                rarities: [
                    { rarity: 'epico', chance: 0.70 },
                    { rarity: 'lendario', chance: 0.30 }
                ]
            },
            mythic: {
                price: 8000,
                rarities: [
                    { rarity: 'lendario', chance: 0.80 },
                    { rarity: 'mitico', chance: 0.15 },
                    { rarity: 'prismatico', chance: 0.05 }
                ]
            }
        };

        // Login System
        function switchTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'login') {
                document.getElementById('loginTab').style.display = 'block';
                document.getElementById('registerTab').style.display = 'none';
            } else {
                document.getElementById('loginTab').style.display = 'none';
                document.getElementById('registerTab').style.display = 'block';
            }
        }

        function registerUser() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!username || !password) {
                showNotification('Preencha todos os campos!', 'failure');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Senhas não coincidem!', 'failure');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Nome deve ter pelo menos 3 caracteres!', 'failure');
                return;
            }
            
            // Check if user already exists
            try {
                const existingUser = localStorage.getItem(`tycoon_user_${username.toLowerCase()}`);
                if (existingUser) {
                    showNotification('Usuário já existe!', 'failure');
                    return;
                }
                
                // Create new user
                const userData = {
                    username: username,
                    password: password,
                    userId: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    inventory: {},
                    money: 100,
                    defenseLevel: 0,
                    createdAt: Date.now()
                };
                
                localStorage.setItem(`tycoon_user_${username.toLowerCase()}`, JSON.stringify(userData));
                console.log('Usuário criado:', userData);
                showNotification('✅ Conta criada com sucesso!', 'success');
                
                // Switch to login tab
                switchTab('login');
                document.getElementById('loginUsername').value = username;
                
            } catch (error) {
                console.error('Erro ao criar conta:', error);
                showNotification('Erro ao criar conta. Tente novamente!', 'failure');
            }
        }

        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const roomCode = document.getElementById('loginRoomCode').value.trim().toUpperCase();
            
            if (!username || !password || !roomCode) {
                showNotification('Preencha todos os campos!', 'failure');
                return;
            }
            
            try {
                // Check user credentials
                const userData = localStorage.getItem(`tycoon_user_${username.toLowerCase()}`);
                if (!userData) {
                    showNotification('❌ Usuário não encontrado! Crie uma conta primeiro.', 'failure');
                    return;
                }
                
                const user = JSON.parse(userData);
                if (user.password !== password) {
                    showNotification('❌ Senha incorreta!', 'failure');
                    return;
                }
                
                // Login successful
                userAccount = {
                    username: user.username,
                    userId: user.userId,
                    roomCode: roomCode
                };
                
                // Load user data
                gameState.money = user.money || 100;
                gameState.inventory = user.inventory || {};
                gameState.base = user.base || {};
                gameState.baseLocked = user.baseLocked || false;
                gameState.baseLockTime = user.baseLockTime || 0;
                gameState.defenseLevel = user.defenseLevel || 0;
                gameState.defenseCost = 300 + (gameState.defenseLevel * 200);
                
                // Check if base lock expired
                if (gameState.baseLocked && Date.now() > gameState.baseLockTime) {
                    gameState.baseLocked = false;
                    gameState.baseLockTime = 0;
                }
                
                multiplayerState.roomCode = roomCode;
                multiplayerState.playerId = user.userId;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('currentRoom').textContent = roomCode;
                document.getElementById('currentPlayer').textContent = username;
                
                console.log('Login realizado:', userAccount);
                console.log('Dados carregados:', gameState);
                
                // Initialize game
                initializeGame();
                connectToRoom();
                
                showNotification(`🎮 Bem-vindo, ${username}! Sala: ${roomCode}`, 'success');
                
            } catch (error) {
                console.error('Erro no login:', error);
                showNotification('Erro ao fazer login. Tente novamente!', 'failure');
            }
        }

        // Save user data
        function saveUserData() {
            if (!userAccount.username) return;
            
            try {
                const existingData = localStorage.getItem(`tycoon_user_${userAccount.username.toLowerCase()}`);
                if (!existingData) return;
                
                const existingUser = JSON.parse(existingData);
                
                const userData = {
                    username: userAccount.username,
                    password: existingUser.password,
                    userId: userAccount.userId,
                    inventory: gameState.inventory,
                    base: gameState.base,
                    baseLocked: gameState.baseLocked,
                    baseLockTime: gameState.baseLockTime,
                    money: gameState.money,
                    defenseLevel: gameState.defenseLevel,
                    lastSave: Date.now(),
                    createdAt: existingUser.createdAt
                };
                
                localStorage.setItem(`tycoon_user_${userAccount.username.toLowerCase()}`, JSON.stringify(userData));
                console.log('Dados salvos:', userData);
                
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }
        }

        // Multiplayer Functions
        async function connectToRoom() {
            try {
                const roomData = await getRoomData();
                
                if (roomData && roomData.players) {
                    roomPlayers = roomData.players;
                } else {
                    roomPlayers = {};
                }
                
                // Add current player
                roomPlayers[multiplayerState.playerId] = {
                    name: userAccount.username,
                    money: gameState.money,
                    income: gameState.income,
                    items: Object.keys(gameState.inventory).length,
                    baseItems: Object.keys(gameState.base).length,
                    baseLocked: gameState.baseLocked,
                    baseLockTime: gameState.baseLockTime,
                    defenseLevel: gameState.defenseLevel,
                    inTrade: gameState.inTrade,
                    lastUpdate: Date.now()
                };
                
                await saveRoomData();
                updatePlayersDisplay();
                
                connectionInterval = setInterval(syncWithServer, 3000);
                
            } catch (error) {
                console.error('Connection error:', error);
            }
        }

        async function getRoomData() {
            try {
                const localData = localStorage.getItem(`tycoon_room_${multiplayerState.roomCode}`);
                if (localData) {
                    const data = JSON.parse(localData);
                    console.log('Dados da sala carregados:', data);
                    return data;
                }
                console.log('Nenhum dado da sala encontrado');
                return { players: {} };
            } catch (error) {
                console.error('Erro ao carregar sala:', error);
                return { players: {} };
            }
        }

        async function saveRoomData() {
            try {
                const roomData = {
                    roomCode: multiplayerState.roomCode,
                    players: roomPlayers,
                    lastUpdate: Date.now()
                };
                
                localStorage.setItem(`tycoon_room_${multiplayerState.roomCode}`, JSON.stringify(roomData));
                console.log('Dados da sala salvos:', roomData);
                return true;
            } catch (error) {
                console.error('Erro ao salvar sala:', error);
                return false;
            }
        }

        async function syncWithServer() {
            try {
                // Get current room data first
                const roomData = await getRoomData();
                if (roomData && roomData.players) {
                    // Merge existing players with current data
                    Object.keys(roomData.players).forEach(playerId => {
                        if (playerId !== multiplayerState.playerId) {
                            roomPlayers[playerId] = roomData.players[playerId];
                        }
                    });
                }
                
                // Update current player data
                roomPlayers[multiplayerState.playerId] = {
                    name: userAccount.username,
                    money: gameState.money,
                    income: gameState.income,
                    items: Object.keys(gameState.inventory).length,
                    baseItems: Object.keys(gameState.base).length,
                    baseLocked: gameState.baseLocked,
                    baseLockTime: gameState.baseLockTime,
                    defenseLevel: gameState.defenseLevel,
                    inTrade: gameState.inTrade,
                    currentTradeOffer: gameState.currentTradeOffer || null,
                    lastUpdate: Date.now()
                };
                
                // Clean up old players (90 seconds timeout - mais tempo para evitar desconexões)
                const currentTime = Date.now();
                Object.keys(roomPlayers).forEach(playerId => {
                    if (playerId !== multiplayerState.playerId && 
                        roomPlayers[playerId].lastUpdate && 
                        currentTime - roomPlayers[playerId].lastUpdate > 90000) {
                        console.log('Removendo jogador inativo:', roomPlayers[playerId].name);
                        delete roomPlayers[playerId];
                    }
                });
                
                await saveRoomData();
                updatePlayersDisplay();
                updateBasesDisplay();
                
                // Check for trade offers
                checkForTradeOffers();
                
                // Save user data
                saveUserData();
                
                console.log('Sync realizado - Jogadores online:', Object.keys(roomPlayers).length);
                
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function updatePlayersDisplay() {
            const playersList = document.getElementById('playersList');
            const otherPlayers = Object.entries(roomPlayers).filter(([id, player]) => id !== multiplayerState.playerId);
            
            document.getElementById('onlineCount').textContent = Object.keys(roomPlayers).length;
            
            if (otherPlayers.length === 0) {
                playersList.innerHTML = '<div style="text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">Você está sozinho na sala.<br>Compartilhe o código!</div>';
                return;
            }
            
            otherPlayers.sort(([,a], [,b]) => b.money - a.money);
            
            playersList.innerHTML = otherPlayers.map(([playerId, player], index) => `
                <div class="player-card">
                    <div class="player-name">
                        <span class="online-indicator"></span>
                        #${index + 1} ${player.name}
                        ${player.inTrade ? '🔄' : ''}
                    </div>
                    <div class="player-stats">
                        💰 $${Math.floor(player.money)} | 📈 $${player.income}/seg<br>
                        🎒 ${player.items} itens | 🛡️ ${player.defenseLevel}
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 8px;">
                        <button class="action-button attack-btn" style="font-size: 0.6rem; padding: 4px; flex: 1;" 
                                onclick="attackSpecificPlayer('${playerId}')"
                                ${player.inTrade ? 'disabled title="Jogador em troca"' : ''}>
                            ${player.inTrade ? '🔒' : '⚔️'}
                        </button>
                        <button class="action-button trade-btn" style="font-size: 0.6rem; padding: 4px; flex: 1;" 
                                onclick="offerTradeToPlayer('${playerId}')"
                                ${player.inTrade || gameState.inTrade || gameState.selectedItems.length === 0 ? 'disabled' : ''}>
                            🔄 Trocar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Game Functions
        function initializeGame() {
            initializeBelt();
            updateDisplay();
            updateInventoryDisplay();
            updateBaseDisplay();
            updateBasesDisplay();
            calculateIncome();
            
            // Start base lock timer update
            setInterval(() => {
                if (gameState.baseLocked) {
                    updateBaseDisplay();
                }
                updateBasesDisplay();
            }, 1000);
        }

        async function initializeBelt() {
            const beltItems = document.getElementById('beltItems');
            
            // Get or create shared belt for the room
            let sharedBelt = await getSharedBelt();
            
            if (!sharedBelt || Date.now() - sharedBelt.lastUpdate > 60000) {
                // Create new belt every 60 seconds
                sharedBelt = generateNewBelt();
                await saveSharedBelt(sharedBelt);
            }
            
            beltItems.innerHTML = sharedBelt.items.map(item => {
                const isSold = sharedBelt.soldItems && sharedBelt.soldItems.includes(item.name);
                return `
                    <div class="belt-item ${item.rarity} ${isSold ? 'sold-out' : ''}" 
                         onclick="${isSold ? '' : `buyFromBelt('${item.name}', ${item.price})`}">
                        ${item.name}<br>
                        <small>+$${item.income}/seg</small>
                        <div class="belt-item-price">${isSold ? 'VENDIDO' : '$' + item.price}</div>
                    </div>
                `;
            }).join('');
        }

        function generateNewBelt() {
            const beltCharacters = [];
            
            // Melhores chances para itens raros na esteira
            characterList.forEach(charName => {
                const char = characterDatabase[charName];
                let chance = 1;
                
                // Chances balanceadas para todas as raridades
                switch(char.rarity) {
                    case 'comum': chance = 0.35; break;       // 35% (reduzido)
                    case 'incomum': chance = 0.28; break;     // 28% (aumentado)
                    case 'raro': chance = 0.22; break;        // 22% (reduzido um pouco)
                    case 'epico': chance = 0.18; break;       // 18% (aumentado)
                    case 'lendario': chance = 0.12; break;    // 12% (aumentado)
                    case 'mitico': chance = 0.08; break;      // 8% (aumentado)
                    case 'prismatico': chance = 0.03; break; // 3% (aumentado)
                }
                
                if (Math.random() < chance) {
                    beltCharacters.push(charName);
                }
            });
            
            // Ensure at least 8 items
            while (beltCharacters.length < 8) {
                const randomChar = characterList[Math.floor(Math.random() * characterList.length)];
                if (!beltCharacters.includes(randomChar)) {
                    beltCharacters.push(randomChar);
                }
            }
            
            // Create belt items with prices
            const beltItems = beltCharacters.map(charName => {
                const char = characterDatabase[charName];
                const price = Math.floor(char.income * 15 + Math.random() * 50);
                return {
                    name: charName,
                    rarity: char.rarity,
                    income: char.income,
                    price: price
                };
            });
            
            return {
                items: beltItems,
                soldItems: [],
                lastUpdate: Date.now()
            };
        }

        async function getSharedBelt() {
            try {
                const beltData = localStorage.getItem(`tycoon_belt_${multiplayerState.roomCode}`);
                return beltData ? JSON.parse(beltData) : null;
            } catch (error) {
                console.error('Error getting shared belt:', error);
                return null;
            }
        }

        async function saveSharedBelt(beltData) {
            try {
                localStorage.setItem(`tycoon_belt_${multiplayerState.roomCode}`, JSON.stringify(beltData));
                console.log('Esteira sincronizada salva:', beltData);
            } catch (error) {
                console.error('Error saving shared belt:', error);
            }
        }

        function collectFromBelt() {
            showNotification('Clique em um item na esteira para comprar!', 'info');
        }

        async function buyFromBelt(characterName, price) {
            const char = characterDatabase[characterName];
            if (!char) return;
            
            if (gameState.money < price) {
                showNotification('Dinheiro insuficiente!', 'failure');
                return;
            }
            
            // Check if item is already sold
            const sharedBelt = await getSharedBelt();
            if (sharedBelt.soldItems && sharedBelt.soldItems.includes(characterName)) {
                showNotification('Item já foi vendido!', 'failure');
                await initializeBelt(); // Refresh belt display
                return;
            }
            
            gameState.money -= price;
            
            // Mark item as sold
            if (!sharedBelt.soldItems) {
                sharedBelt.soldItems = [];
            }
            sharedBelt.soldItems.push(characterName);
            await saveSharedBelt(sharedBelt);
            
            // Add to both base AND inventory
            if (gameState.base[characterName]) {
                gameState.base[characterName]++;
            } else {
                gameState.base[characterName] = 1;
            }
            
            if (gameState.inventory[characterName]) {
                gameState.inventory[characterName]++;
            } else {
                gameState.inventory[characterName] = 1;
            }
            
            calculateIncome();
            updateInventoryDisplay();
            updateBaseDisplay();
            updateBasesDisplay();
            updateDisplay();
            
            // Refresh belt to show sold status
            await initializeBelt();
            
            showNotification(`Comprou ${characterName} por $${price}! Adicionado à base e inventário!`, 'success');
        }

        function calculateIncome() {
            gameState.income = 0;
            
            // Income from inventory
            Object.entries(gameState.inventory).forEach(([charName, count]) => {
                const char = characterDatabase[charName];
                if (char) {
                    gameState.income += char.income * count;
                }
            });
            
            // Income from base
            Object.entries(gameState.base).forEach(([charName, count]) => {
                const char = characterDatabase[charName];
                if (char) {
                    gameState.income += char.income * count;
                }
            });
        }

        function buyCrate(crateType) {
            const crate = crateTypes[crateType];
            if (!crate) return;
            
            if (gameState.money < crate.price) {
                showNotification('Dinheiro insuficiente!', 'failure');
                return;
            }
            
            gameState.money -= crate.price;
            
            // Determine rarity
            const rand = Math.random();
            let cumulativeChance = 0;
            let selectedRarity = 'comum';
            
            for (let rarityData of crate.rarities) {
                cumulativeChance += rarityData.chance;
                if (rand <= cumulativeChance) {
                    selectedRarity = rarityData.rarity;
                    break;
                }
            }
            
            // Get random character of selected rarity
            const charactersOfRarity = characterList.filter(name => 
                characterDatabase[name].rarity === selectedRarity
            );
            
            if (charactersOfRarity.length === 0) {
                showNotification('Erro no crate!', 'failure');
                return;
            }
            
            const randomChar = charactersOfRarity[Math.floor(Math.random() * charactersOfRarity.length)];
            
            // Add to both inventory and base
            if (gameState.inventory[randomChar]) {
                gameState.inventory[randomChar]++;
            } else {
                gameState.inventory[randomChar] = 1;
            }
            
            if (gameState.base[randomChar]) {
                gameState.base[randomChar]++;
            } else {
                gameState.base[randomChar] = 1;
            }
            
            calculateIncome();
            updateInventoryDisplay();
            updateBaseDisplay();
            updateBasesDisplay();
            updateDisplay();
            
            showNotification(`Crate aberto! Recebeu ${randomChar} (${selectedRarity})!`, 'success');
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            
            if (Object.keys(gameState.inventory).length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">Inventário vazio. Compre crates ou colete da esteira!</div>';
                return;
            }
            
            const sortedItems = Object.entries(gameState.inventory).sort(([a], [b]) => {
                const rarityOrder = { 'prismatico': 7, 'mitico': 6, 'lendario': 5, 'epico': 4, 'raro': 3, 'incomum': 2, 'comum': 1 };
                return rarityOrder[characterDatabase[b].rarity] - rarityOrder[characterDatabase[a].rarity];
            });
            
            grid.innerHTML = sortedItems.map(([charName, count]) => {
                const char = characterDatabase[charName];
                const isSelected = gameState.selectedItems.includes(charName);
                const inTrade = gameState.inTrade;
                
                return `
                    <div class="inventory-item ${char.rarity} ${isSelected ? 'selected' : ''} ${inTrade ? 'in-trade' : ''}" 
                         onclick="selectItem('${charName}')">
                        <div class="item-name">${charName}</div>
                        <div class="item-income">+$${char.income}/seg</div>
                        ${count > 1 ? `<div class="item-count">${count}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectItem(characterName) {
            if (gameState.inTrade) {
                showNotification('Você está em uma troca!', 'warning');
                return;
            }
            
            const index = gameState.selectedItems.indexOf(characterName);
            if (index > -1) {
                gameState.selectedItems.splice(index, 1);
            } else {
                if (gameState.selectedItems.length >= 3) {
                    showNotification('Máximo 3 itens por troca!', 'warning');
                    return;
                }
                gameState.selectedItems.push(characterName);
            }
            
            updateInventoryDisplay();
            updateSelectedItemsDisplay();
        }

        function updateSelectedItemsDisplay() {
            const selectedList = document.getElementById('selectedItemsList');
            
            if (gameState.selectedItems.length === 0) {
                selectedList.textContent = 'Nenhum item selecionado';
                document.getElementById('tradeBotBtn').disabled = true;
            } else {
                selectedList.textContent = gameState.selectedItems.join(', ');
                document.getElementById('tradeBotBtn').disabled = false;
            }
        }

        function tradeWithBot() {
            if (gameState.selectedItems.length === 0) {
                showNotification('Selecione itens para trocar!', 'warning');
                return;
            }
            
            gameState.inTrade = true;
            updateTradingStatus();
            
            // Calculate trade value
            let tradeValue = 0;
            gameState.selectedItems.forEach(charName => {
                const char = characterDatabase[charName];
                tradeValue += char.income * 10; // Base trade value
            });
            
            // Bot offers random items of similar value
            const botOffer = generateBotOffer(tradeValue);
            
            setTimeout(() => {
                const accept = confirm(`Bot oferece:\n${botOffer.items.join('\n')}\n\nAceitar troca?`);
                
                if (accept) {
                    // Remove selected items
                    gameState.selectedItems.forEach(charName => {
                        gameState.inventory[charName]--;
                        if (gameState.inventory[charName] <= 0) {
                            delete gameState.inventory[charName];
                        }
                    });
                    
                    // Add bot items
                    botOffer.items.forEach(charName => {
                        if (gameState.inventory[charName]) {
                            gameState.inventory[charName]++;
                        } else {
                            gameState.inventory[charName] = 1;
                        }
                    });
                    
                    showNotification('Troca realizada com sucesso!', 'success');
                } else {
                    showNotification('Troca cancelada!', 'info');
                }
                
                gameState.selectedItems = [];
                gameState.inTrade = false;
                updateTradingStatus();
                calculateIncome();
                updateInventoryDisplay();
                updateSelectedItemsDisplay();
                updateDisplay();
                
            }, 2000);
        }

        function generateBotOffer(targetValue) {
            const availableChars = characterList.filter(name => 
                !gameState.selectedItems.includes(name)
            );
            
            const offer = [];
            let currentValue = 0;
            
            while (currentValue < targetValue * 0.8 && offer.length < 3) {
                const randomChar = availableChars[Math.floor(Math.random() * availableChars.length)];
                const char = characterDatabase[randomChar];
                
                if (!offer.includes(randomChar)) {
                    offer.push(randomChar);
                    currentValue += char.income * 10;
                }
            }
            
            return { items: offer, value: currentValue };
        }

        function updateTradingStatus() {
            const status = document.getElementById('tradingStatus');
            
            if (gameState.inTrade) {
                status.className = 'trading-status active';
                status.innerHTML = '🟡 Em negociação...';
            } else {
                status.className = 'trading-status inactive';
                status.innerHTML = '🟢 Disponível para trocas';
            }
        }

        function attackSpecificPlayer(targetPlayerId) {
            const targetPlayer = roomPlayers[targetPlayerId];
            if (!targetPlayer) {
                showNotification('Jogador não encontrado!', 'failure');
                return;
            }
            
            if (targetPlayer.inTrade) {
                showNotification(`${targetPlayer.name} está protegido (em troca)!`, 'warning');
                return;
            }
            
            if (targetPlayer.items === 0) {
                showNotification(`${targetPlayer.name} não tem itens!`, 'warning');
                return;
            }
            
            const successRate = 0.4; // Aumentado para 40%
            const defenseChance = Math.min(0.7, targetPlayer.defenseLevel * 0.08); // Reduzido um pouco
            
            if (Math.random() <= defenseChance) {
                showNotification(`🛡️ ${targetPlayer.name} bloqueou seu ataque!`, 'failure');
                return;
            }
            
            if (Math.random() <= successRate) {
                // Simular roubo de item aleatório
                const commonItems = ['Tralalero Tralala', 'Lirilì Larilà', 'Hipocactus', 'Trippi Troppi'];
                const stolenItem = commonItems[Math.floor(Math.random() * commonItems.length)];
                
                // Add stolen item to attacker's inventory and base
                if (gameState.inventory[stolenItem]) {
                    gameState.inventory[stolenItem]++;
                } else {
                    gameState.inventory[stolenItem] = 1;
                }
                
                if (gameState.base[stolenItem]) {
                    gameState.base[stolenItem]++;
                } else {
                    gameState.base[stolenItem] = 1;
                }
                
                calculateIncome();
                updateInventoryDisplay();
                updateBaseDisplay();
                updateDisplay();
                
                showNotification(`⚔️ Roubou ${stolenItem} de ${targetPlayer.name}!`, 'success');
                saveRoomData();
            } else {
                showNotification(`❌ Falhou ao atacar ${targetPlayer.name}!`, 'failure');
            }
        }

        function attackRandomPlayer() {
            const otherPlayers = Object.keys(roomPlayers).filter(id => id !== multiplayerState.playerId);
            
            if (otherPlayers.length === 0) {
                showNotification('Nenhum outro jogador online!', 'warning');
                return;
            }
            
            const randomPlayerId = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
            attackSpecificPlayer(randomPlayerId);
        }

        function upgradeDefense() {
            if (gameState.money >= gameState.defenseCost) {
                gameState.money -= gameState.defenseCost;
                gameState.defenseLevel++;
                gameState.defenseCost = Math.floor(gameState.defenseCost * 1.8);
                
                showNotification(`Defesa melhorada! Nível ${gameState.defenseLevel}`, 'info');
                updateDisplay();
            }
        }

        function updateDisplay() {
            document.getElementById('money').textContent = Math.floor(gameState.money);
            document.getElementById('income').textContent = gameState.income;
            document.getElementById('defenseLevel').textContent = Math.min(80, gameState.defenseLevel * 10);
            document.getElementById('defenseCost').textContent = gameState.defenseCost;
            document.getElementById('totalItems').textContent = Object.keys(gameState.inventory).length;
            
            let totalValue = 0;
            Object.entries(gameState.inventory).forEach(([charName, count]) => {
                const char = characterDatabase[charName];
                if (char) {
                    totalValue += char.income * count * 10;
                }
            });
            document.getElementById('totalValue').textContent = totalValue;
            
            document.getElementById('defenseDisplayLevel').textContent = gameState.defenseLevel;
            document.getElementById('defensePercentage').textContent = Math.min(80, gameState.defenseLevel * 10);

            document.getElementById('defenseUpgrade').disabled = gameState.money < gameState.defenseCost;
        }

        function updateBaseDisplay() {
            const myBaseItems = document.getElementById('myBaseItems');
            const myBaseStatus = document.getElementById('myBaseStatus');
            const lockBaseBtn = document.getElementById('lockBaseBtn');
            
            // Update base status
            if (gameState.baseLocked) {
                const timeLeft = Math.max(0, gameState.baseLockTime - Date.now());
                if (timeLeft > 0) {
                    const secondsLeft = Math.ceil(timeLeft / 1000);
                    myBaseStatus.textContent = `Trancada (${secondsLeft}s)`;
                    myBaseStatus.className = 'base-status locked';
                    lockBaseBtn.disabled = true;
                    lockBaseBtn.textContent = `🔒 Trancada (${secondsLeft}s)`;
                } else {
                    gameState.baseLocked = false;
                    gameState.baseLockTime = 0;
                    myBaseStatus.textContent = 'Desbloqueada';
                    myBaseStatus.className = 'base-status unlocked';
                    lockBaseBtn.disabled = false;
                    lockBaseBtn.textContent = '🔒 Trancar (60s)';
                }
            } else {
                myBaseStatus.textContent = 'Desbloqueada';
                myBaseStatus.className = 'base-status unlocked';
                lockBaseBtn.disabled = false;
                lockBaseBtn.textContent = '🔒 Trancar (60s)';
            }
            
            // Update base items
            if (Object.keys(gameState.base).length === 0) {
                myBaseItems.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 10px; font-size: 0.7rem;">Base vazia</div>';
                return;
            }
            
            const sortedBaseItems = Object.entries(gameState.base).sort(([a], [b]) => {
                const rarityOrder = { 'prismatico': 7, 'mitico': 6, 'lendario': 5, 'epico': 4, 'raro': 3, 'incomum': 2, 'comum': 1 };
                return rarityOrder[characterDatabase[b].rarity] - rarityOrder[characterDatabase[a].rarity];
            });
            
            myBaseItems.innerHTML = sortedBaseItems.map(([charName, count]) => {
                const char = characterDatabase[charName];
                return `
                    <div class="base-item ${char.rarity}">
                        ${charName}
                        ${count > 1 ? `<div style="font-size: 0.5rem;">${count}x</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateBasesDisplay() {
            const otherBases = document.getElementById('otherBases');
            const otherPlayers = Object.entries(roomPlayers).filter(([id, player]) => id !== multiplayerState.playerId);
            
            if (otherPlayers.length === 0) {
                otherBases.innerHTML = '<div style="text-align: center; color: #ccc; padding: 15px; font-size: 0.8rem;">Nenhuma outra base encontrada</div>';
                return;
            }
            
            otherBases.innerHTML = otherPlayers.map(([playerId, player]) => {
                const isLocked = player.baseLocked && Date.now() < player.baseLockTime;
                const timeLeft = isLocked ? Math.max(0, player.baseLockTime - Date.now()) : 0;
                const secondsLeft = Math.ceil(timeLeft / 1000);
                
                return `
                    <div class="base-card ${isLocked ? 'base-locked' : ''}">
                        <div class="base-header">
                            <div class="base-name">🏠 ${player.name}</div>
                            <div class="base-status ${isLocked ? 'locked' : 'unlocked'}">
                                ${isLocked ? `Trancada (${secondsLeft}s)` : 'Desbloqueada'}
                            </div>
                        </div>
                        <div class="base-items">
                            ${player.baseItems > 0 ? 
                                `<div class="base-item">💎 ${player.baseItems} itens</div>` : 
                                '<div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 10px; font-size: 0.7rem;">Base vazia</div>'
                            }
                        </div>
                        <div class="base-actions">
                            <button class="action-button raid-btn" style="font-size: 0.7rem; padding: 6px; flex: 1;" 
                                    onclick="raidBase('${playerId}')"
                                    ${isLocked || player.baseItems === 0 || gameState.inTrade ? 'disabled' : ''}>
                                ${isLocked ? '🔒 Trancada' : player.baseItems === 0 ? '📭 Vazia' : '🎯 Hackear'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function lockMyBase() {
            if (gameState.baseLocked) return;
            
            gameState.baseLocked = true;
            gameState.baseLockTime = Date.now() + 60000; // 60 seconds
            
            updateBaseDisplay();
            showNotification('🔒 Base trancada por 60 segundos!', 'info');
        }

        function raidBase(targetPlayerId) {
            const targetPlayer = roomPlayers[targetPlayerId];
            if (!targetPlayer) {
                showNotification('Jogador não encontrado!', 'failure');
                return;
            }
            
            if (targetPlayer.baseLocked && Date.now() < targetPlayer.baseLockTime) {
                showNotification(`Base de ${targetPlayer.name} está trancada!`, 'warning');
                return;
            }
            
            if (targetPlayer.baseItems === 0) {
                showNotification(`Base de ${targetPlayer.name} está vazia!`, 'warning');
                return;
            }
            
            if (gameState.inTrade) {
                showNotification('Você não pode hackear durante uma troca!', 'warning');
                return;
            }
            
            // Start minigame
            minigameTarget = targetPlayerId;
            startMinigame();
        }

        function startMinigame() {
            minigameActive = true;
            minigameProgress = 0;
            minigameRound = 0;
            minigameSuccess = 0;
            
            document.getElementById('minigameModal').style.display = 'flex';
            document.getElementById('minigameProgress').style.width = '0%';
            
            nextMinigameRound();
        }

        function nextMinigameRound() {
            if (minigameRound >= 3) {
                finishMinigame();
                return;
            }
            
            minigameRound++;
            const button = document.getElementById('minigameButton');
            const timer = document.getElementById('minigameTimer');
            
            button.className = 'minigame-button';
            button.disabled = true;
            
            timer.textContent = `Rodada ${minigameRound}/3 - Prepare-se...`;
            
            // Random delay between 1-3 seconds
            const delay = 1000 + Math.random() * 2000;
            
            setTimeout(() => {
                if (!minigameActive) return;
                
                button.className = 'minigame-button active';
                button.disabled = false;
                timer.textContent = 'AGORA! Clique rápido!';
                
                // Player has 1 second to click
                minigameTimer = setTimeout(() => {
                    if (!minigameActive) return;
                    
                    button.className = 'minigame-button';
                    button.disabled = true;
                    timer.textContent = 'Muito lento!';
                    
                    setTimeout(() => {
                        if (minigameActive) nextMinigameRound();
                    }, 1000);
                    
                }, 1000);
                
            }, delay);
        }

        function minigameClick() {
            if (!minigameActive) return;
            
            const button = document.getElementById('minigameButton');
            if (!button.classList.contains('active')) return;
            
            clearTimeout(minigameTimer);
            minigameSuccess++;
            
            button.className = 'minigame-button';
            button.disabled = true;
            
            document.getElementById('minigameTimer').textContent = 'Acertou!';
            document.getElementById('minigameProgress').style.width = `${(minigameSuccess / 3) * 100}%`;
            
            setTimeout(() => {
                if (minigameActive) nextMinigameRound();
            }, 800);
        }

        function finishMinigame() {
            minigameActive = false;
            
            const successRate = minigameSuccess / 3;
            const targetPlayer = roomPlayers[minigameTarget];
            
            if (successRate >= 0.67) { // Need at least 2/3 success
                // Successful raid - steal random items
                const possibleItems = ['Tralalero Tralala', 'Lirilì Larilà', 'Hipocactus', 'Trippi Troppi', 'Fruli Frula', 'Pot Hotspot'];
                const itemsToSteal = Math.floor(Math.random() * 3) + 1; // 1-3 items
                const stolenItems = [];
                
                for (let i = 0; i < itemsToSteal; i++) {
                    const randomItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    stolenItems.push(randomItem);
                    
                    // Add to attacker's inventory and base
                    if (gameState.inventory[randomItem]) {
                        gameState.inventory[randomItem]++;
                    } else {
                        gameState.inventory[randomItem] = 1;
                    }
                    
                    if (gameState.base[randomItem]) {
                        gameState.base[randomItem]++;
                    } else {
                        gameState.base[randomItem] = 1;
                    }
                }
                
                calculateIncome();
                updateInventoryDisplay();
                updateBaseDisplay();
                updateDisplay();
                
                showNotification(`🎯 Hackear bem-sucedido! Roubou: ${stolenItems.join(', ')} de ${targetPlayer.name}!`, 'success');
                
            } else {
                showNotification(`❌ Hackear falhou! Conseguiu apenas ${minigameSuccess}/3 acertos.`, 'failure');
            }
            
            document.getElementById('minigameModal').style.display = 'none';
            saveRoomData();
        }

        function cancelMinigame() {
            minigameActive = false;
            if (minigameTimer) {
                clearTimeout(minigameTimer);
            }
            document.getElementById('minigameModal').style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3500);
        }

        // Game loops
        setInterval(() => {
            gameState.money += gameState.income;
            updateDisplay();
        }, 1000);

        // Refresh belt every 60 seconds
        setInterval(async () => {
            await initializeBelt();
        }, 60000);

        // Auto-save every 30 seconds
        setInterval(() => {
            saveUserData();
        }, 30000);

        // Test system function
        function testSystem() {
            console.log('=== TESTE DO SISTEMA ===');
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'funcionando');
                const test = localStorage.getItem('test');
                console.log('✅ LocalStorage funcionando:', test);
                localStorage.removeItem('test');
            } catch (error) {
                console.error('❌ LocalStorage com problema:', error);
            }
            
            // Show existing accounts
            console.log('=== CONTAS EXISTENTES ===');
            let accountCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tycoon_user_')) {
                    accountCount++;
                    const userData = JSON.parse(localStorage.getItem(key));
                    console.log(`Conta ${accountCount}:`, userData.username, '- Dinheiro:', userData.money);
                }
            }
            
            if (accountCount === 0) {
                console.log('Nenhuma conta encontrada');
            }
            
            // Show existing rooms
            console.log('=== SALAS EXISTENTES ===');
            let roomCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tycoon_room_')) {
                    roomCount++;
                    const roomData = JSON.parse(localStorage.getItem(key));
                    console.log(`Sala ${roomCount}:`, roomData.roomCode, '- Jogadores:', Object.keys(roomData.players).length);
                }
            }
            
            if (roomCount === 0) {
                console.log('Nenhuma sala encontrada');
            }
            
            alert('Teste concluído! Verifique o console (F12) para detalhes.');
        }

        // Player-to-Player Trading Functions
        function offerTradeToPlayer(targetPlayerId) {
            if (gameState.selectedItems.length === 0) {
                showNotification('Selecione itens para trocar!', 'warning');
                return;
            }
            
            if (gameState.inTrade) {
                showNotification('Você já está em uma troca!', 'warning');
                return;
            }
            
            const targetPlayer = roomPlayers[targetPlayerId];
            if (!targetPlayer) {
                showNotification('Jogador não encontrado!', 'failure');
                return;
            }
            
            if (targetPlayer.inTrade) {
                showNotification(`${targetPlayer.name} já está em uma troca!`, 'warning');
                return;
            }
            
            // Create trade offer
            const tradeId = 'trade_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            gameState.currentTradeOffer = {
                id: tradeId,
                initiator: multiplayerState.playerId,
                initiatorName: userAccount.username,
                target: targetPlayerId,
                targetName: targetPlayer.name,
                initiatorItems: [...gameState.selectedItems],
                targetItems: [],
                initiatorConfirmed: false,
                targetConfirmed: false,
                status: 'pending',
                lastUpdate: Date.now()
            };
            
            gameState.inTrade = true;
            gameState.tradePartner = targetPlayerId;
            
            // Clear selected items after creating offer
            gameState.selectedItems = [];
            updateSelectedItemsDisplay();
            updateInventoryDisplay();
            
            // Save trade offer to room
            saveTradeOffer();
            
            // Show trade modal
            showTradeModal();
            
            showNotification(`Oferta de troca enviada para ${targetPlayer.name}!`, 'info');
        }

        async function saveTradeOffer() {
            try {
                const tradeKey = `tycoon_trade_${gameState.currentTradeOffer.id}`;
                gameState.currentTradeOffer.lastUpdate = Date.now();
                localStorage.setItem(tradeKey, JSON.stringify(gameState.currentTradeOffer));
                console.log('Trade offer saved:', gameState.currentTradeOffer);
            } catch (error) {
                console.error('Error saving trade offer:', error);
            }
        }

        function checkForTradeOffers() {
            // Check for incoming trade offers
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tycoon_trade_')) {
                    try {
                        const tradeOffer = JSON.parse(localStorage.getItem(key));
                        
                        // Clean up old trades (5 minutes)
                        const tradeAge = Date.now() - tradeOffer.lastUpdate;
                        if (tradeAge > 300000) {
                            localStorage.removeItem(key);
                            continue;
                        }
                        
                        // Check if this is a trade offer for us
                        if (tradeOffer.target === multiplayerState.playerId && 
                            tradeOffer.status === 'pending' && 
                            !gameState.inTrade) {
                            
                            // Accept the trade offer
                            gameState.currentTradeOffer = tradeOffer;
                            gameState.inTrade = true;
                            gameState.tradePartner = tradeOffer.initiator;
                            
                            showTradeModal();
                            showNotification(`${tradeOffer.initiatorName} quer trocar com você!`, 'info');
                            
                            break;
                        }
                        
                        // Update existing trade if we're part of it
                        if ((tradeOffer.initiator === multiplayerState.playerId || tradeOffer.target === multiplayerState.playerId) &&
                            gameState.currentTradeOffer && gameState.currentTradeOffer.id === tradeOffer.id) {
                            
                            gameState.currentTradeOffer = tradeOffer;
                            updateTradeDisplay();
                        }
                        
                    } catch (error) {
                        console.error('Error checking trade offer:', error);
                        localStorage.removeItem(key);
                    }
                }
            }
        }

        function showTradeModal() {
            if (!gameState.currentTradeOffer) return;
            
            document.getElementById('tradeModal').style.display = 'flex';
            
            // Set partner name correctly
            const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
            const partnerName = isInitiator ? gameState.currentTradeOffer.targetName : gameState.currentTradeOffer.initiatorName;
            document.getElementById('partnerName').textContent = partnerName;
            
            updateTradeDisplay();
        }

        function updateTradeDisplay() {
            if (!gameState.currentTradeOffer) return;
            
            const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
            
            // Get correct items for each side
            const myItems = isInitiator ? gameState.currentTradeOffer.initiatorItems : gameState.currentTradeOffer.targetItems;
            const theirItems = isInitiator ? gameState.currentTradeOffer.targetItems : gameState.currentTradeOffer.initiatorItems;
            
            // Update your items
            const yourItems = document.getElementById('yourTradeItems');
            if (myItems.length === 0) {
                yourItems.innerHTML = `
                    <div class="trade-empty">Clique nos seus itens abaixo para adicionar à troca</div>
                    <div class="trade-inventory">
                        ${Object.entries(gameState.inventory).map(([itemName, count]) => {
                            const char = characterDatabase[itemName];
                            return `
                                <div class="trade-inventory-item ${char.rarity}" onclick="addToTrade('${itemName}')">
                                    ${itemName}
                                    ${count > 1 ? `<span class="item-count">${count}</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                yourItems.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        ${myItems.map(itemName => {
                            const char = characterDatabase[itemName];
                            return `
                                <div class="trade-item ${char.rarity}" onclick="removeFromTrade('${itemName}')">
                                    ${itemName}<br><small>+$${char.income}/seg</small>
                                    <div style="font-size: 0.6rem; color: #ccc; margin-top: 2px;">Clique para remover</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="trade-inventory">
                        ${Object.entries(gameState.inventory).filter(([itemName]) => !myItems.includes(itemName)).map(([itemName, count]) => {
                            const char = characterDatabase[itemName];
                            return `
                                <div class="trade-inventory-item ${char.rarity}" onclick="addToTrade('${itemName}')">
                                    ${itemName}
                                    ${count > 1 ? `<span class="item-count">${count}</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // Update partner items
            const partnerItems = document.getElementById('partnerTradeItems');
            if (theirItems.length === 0) {
                partnerItems.innerHTML = '<div class="trade-empty">Aguardando oferta do parceiro...</div>';
            } else {
                partnerItems.innerHTML = theirItems.map(itemName => {
                    const char = characterDatabase[itemName];
                    return `<div class="trade-item ${char.rarity}">${itemName}<br><small>+$${char.income}/seg</small></div>`;
                }).join('');
            }
            
            // Update status and buttons
            const status = document.getElementById('tradeStatus');
            const confirmBtn = document.getElementById('confirmTradeBtn');
            
            const myConfirmed = isInitiator ? gameState.currentTradeOffer.initiatorConfirmed : gameState.currentTradeOffer.targetConfirmed;
            const theirConfirmed = isInitiator ? gameState.currentTradeOffer.targetConfirmed : gameState.currentTradeOffer.initiatorConfirmed;
            
            if (myConfirmed && theirConfirmed) {
                status.textContent = '✅ Ambos confirmaram! Executando troca...';
                status.className = 'trade-status confirmed';
                confirmBtn.disabled = true;
                
                // Execute trade after 2 seconds
                setTimeout(executeTrade, 2000);
                
            } else if (myConfirmed) {
                status.textContent = '⏳ Você confirmou! Aguardando o parceiro...';
                status.className = 'trade-status waiting';
                confirmBtn.disabled = true;
                
            } else if (theirConfirmed) {
                status.textContent = '⏳ Parceiro confirmou! Sua vez de confirmar...';
                status.className = 'trade-status waiting';
                confirmBtn.disabled = myItems.length === 0;
                
            } else {
                status.textContent = '🔄 Adicione itens e confirme a troca';
                status.className = 'trade-status';
                confirmBtn.disabled = myItems.length === 0;
            }
        }

        function addToTrade(itemName) {
            if (!gameState.currentTradeOffer) return;
            
            const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
            const myItems = isInitiator ? gameState.currentTradeOffer.initiatorItems : gameState.currentTradeOffer.targetItems;
            
            if (myItems.length >= 5) {
                showNotification('Máximo 5 itens por troca!', 'warning');
                return;
            }
            
            if (myItems.includes(itemName)) {
                showNotification('Item já adicionado!', 'warning');
                return;
            }
            
            if (!gameState.inventory[itemName] || gameState.inventory[itemName] <= 0) {
                showNotification('Você não tem este item!', 'warning');
                return;
            }
            
            // Add item to trade
            if (isInitiator) {
                gameState.currentTradeOffer.initiatorItems.push(itemName);
            } else {
                gameState.currentTradeOffer.targetItems.push(itemName);
            }
            
            // Reset confirmations when items change
            if (isInitiator) {
                gameState.currentTradeOffer.initiatorConfirmed = false;
            } else {
                gameState.currentTradeOffer.targetConfirmed = false;
            }
            gameState.currentTradeOffer.initiatorConfirmed = false;
            gameState.currentTradeOffer.targetConfirmed = false;
            
            saveTradeOffer();
            updateTradeDisplay();
        }

        function removeFromTrade(itemName) {
            if (!gameState.currentTradeOffer) return;
            
            const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
            
            if (isInitiator) {
                const index = gameState.currentTradeOffer.initiatorItems.indexOf(itemName);
                if (index > -1) {
                    gameState.currentTradeOffer.initiatorItems.splice(index, 1);
                    gameState.currentTradeOffer.initiatorConfirmed = false;
                }
            } else {
                const index = gameState.currentTradeOffer.targetItems.indexOf(itemName);
                if (index > -1) {
                    gameState.currentTradeOffer.targetItems.splice(index, 1);
                    gameState.currentTradeOffer.targetConfirmed = false;
                }
            }
            
            // Reset all confirmations when items change
            gameState.currentTradeOffer.initiatorConfirmed = false;
            gameState.currentTradeOffer.targetConfirmed = false;
            
            saveTradeOffer();
            updateTradeDisplay();
        }

        function confirmTrade() {
            if (!gameState.currentTradeOffer) return;
            
            const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
            const myItems = isInitiator ? gameState.currentTradeOffer.initiatorItems : gameState.currentTradeOffer.targetItems;
            
            if (myItems.length === 0) {
                showNotification('Adicione pelo menos um item!', 'warning');
                return;
            }
            
            // Confirm trade
            if (isInitiator) {
                gameState.currentTradeOffer.initiatorConfirmed = true;
            } else {
                gameState.currentTradeOffer.targetConfirmed = true;
            }
            
            saveTradeOffer();
            updateTradeDisplay();
            
            showNotification('Troca confirmada! Aguardando o parceiro...', 'success');
        }

        function executeTrade() {
            if (!gameState.currentTradeOffer) return;
            
            try {
                const isInitiator = gameState.currentTradeOffer.initiator === multiplayerState.playerId;
                const myItems = isInitiator ? gameState.currentTradeOffer.initiatorItems : gameState.currentTradeOffer.targetItems;
                const theirItems = isInitiator ? gameState.currentTradeOffer.targetItems : gameState.currentTradeOffer.initiatorItems;
                
                // Remove my items
                myItems.forEach(itemName => {
                    if (gameState.inventory[itemName]) {
                        gameState.inventory[itemName]--;
                        if (gameState.inventory[itemName] <= 0) {
                            delete gameState.inventory[itemName];
                        }
                    }
                });
                
                // Add their items
                theirItems.forEach(itemName => {
                    if (gameState.inventory[itemName]) {
                        gameState.inventory[itemName]++;
                    } else {
                        gameState.inventory[itemName] = 1;
                    }
                });
                
                // Clean up trade
                localStorage.removeItem(`tycoon_trade_${gameState.currentTradeOffer.id}`);
                
                showNotification('🎉 Troca realizada com sucesso!', 'success');
                
                cancelTrade();
                calculateIncome();
                updateInventoryDisplay();
                updateDisplay();
                
            } catch (error) {
                console.error('Error executing trade:', error);
                showNotification('Erro na troca! Tente novamente.', 'failure');
                cancelTrade();
            }
        }

        function cancelTrade() {
            if (gameState.currentTradeOffer) {
                // Clean up trade offer
                localStorage.removeItem(`tycoon_trade_${gameState.currentTradeOffer.id}`);
            }
            
            gameState.currentTradeOffer = null;
            gameState.inTrade = false;
            gameState.tradePartner = null;
            gameState.selectedItems = [];
            
            document.getElementById('tradeModal').style.display = 'none';
            
            updateInventoryDisplay();
            updateSelectedItemsDisplay();
            updateTradingStatus();
        }

        // Admin Challenge Functions
        function startAdminChallenge() {
            if (adminState.isAdmin) {
                document.getElementById('adminPanel').style.display = 'flex';
                populateAdminPanel();
                return;
            }
            
            if (adminState.adminChallengeActive) {
                showNotification('Desafio já em andamento!', 'warning');
                return;
            }
            
            adminState.adminChallengeActive = true;
            adminState.adminChallengeRound = 0;
            adminState.adminChallengeSuccess = 0;
            
            document.getElementById('minigameModal').style.display = 'flex';
            document.getElementById('minigameTitle').textContent = '👑 DESAFIO ADMIN - ULTRA DIFÍCIL';
            document.getElementById('minigameInstructions').textContent = 'Você precisa de reflexos PERFEITOS! 5 rodadas, tempo mínimo!';
            document.getElementById('minigameProgress').style.width = '0%';
            
            minigameActive = true;
            nextAdminChallengeRound();
        }

        function nextAdminChallengeRound() {
            if (adminState.adminChallengeRound >= 5) {
                finishAdminChallenge();
                return;
            }
            
            adminState.adminChallengeRound++;
            const button = document.getElementById('minigameButton');
            const timer = document.getElementById('minigameTimer');
            
            button.className = 'minigame-button';
            button.disabled = true;
            button.textContent = '👑';
            
            timer.textContent = `RODADA ${adminState.adminChallengeRound}/5 - PREPARE-SE...`;
            
            // MUITO mais difícil - delay menor e tempo de reação menor
            const delay = 500 + Math.random() * 800; // 0.5-1.3s
            
            setTimeout(() => {
                if (!minigameActive) return;
                
                button.className = 'minigame-button active';
                button.disabled = false;
                timer.textContent = 'AGORA! RÁPIDO!';
                
                // Apenas 0.4 segundos para clicar!
                adminState.adminChallengeTimer = setTimeout(() => {
                    if (!minigameActive) return;
                    
                    button.className = 'minigame-button';
                    button.disabled = true;
                    timer.textContent = 'MUITO LENTO! FALHOU!';
                    
                    setTimeout(() => {
                        if (minigameActive) nextAdminChallengeRound();
                    }, 1000);
                    
                }, 400); // Apenas 400ms!
                
            }, delay);
        }

        function finishAdminChallenge() {
            minigameActive = false;
            adminState.adminChallengeActive = false;
            
            const successRate = adminState.adminChallengeSuccess / 5;
            
            if (successRate >= 1.0) { // Precisa acertar TODAS as 5!
                adminState.adminWins++;
                document.getElementById('adminWins').textContent = adminState.adminWins;
                
                if (adminState.adminWins >= 3) {
                    adminState.isAdmin = true;
                    showNotification('🔥 PARABÉNS! VOCÊ É AGORA UM ADMINISTRADOR! 🔥', 'success');
                    document.getElementById('adminChallengeBtn').textContent = '👑 PAINEL ADMIN';
                    document.getElementById('adminChallengeBtn').style.background = 'linear-gradient(45deg, #FFD700, #FF6B35)';
                } else {
                    showNotification(`👑 Perfeito! ${adminState.adminWins}/3 vitórias para admin!`, 'success');
                }
            } else {
                showNotification(`❌ Falhou! Conseguiu apenas ${adminState.adminChallengeSuccess}/5 acertos perfeitos.`, 'failure');
            }
            
            document.getElementById('minigameModal').style.display = 'none';
            
            // Reset for next attempt
            adminState.adminChallengeSuccess = 0;
        }

        function populateAdminPanel() {
            // Populate character dropdown
            const characterSelect = document.getElementById('adminCharacter');
            characterSelect.innerHTML = '<option value="">Selecionar personagem...</option>';
            
            Object.keys(characterDatabase).forEach(charName => {
                const char = characterDatabase[charName];
                characterSelect.innerHTML += `<option value="${charName}">${charName} (${char.rarity})</option>`;
            });
            
            // Populate players list
            updateAdminPlayersList();
        }

        function updateAdminPlayersList() {
            const playersList = document.getElementById('adminPlayersList');
            const players = Object.entries(roomPlayers);
            
            if (players.length === 0) {
                playersList.innerHTML = '<div style="text-align: center; color: #ccc;">Nenhum jogador online</div>';
                return;
            }
            
            playersList.innerHTML = players.map(([playerId, player]) => `
                <div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${player.name}</strong><br>
                        <small>💰 $${Math.floor(player.money)} | 🎒 ${player.items} itens</small>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="action-button" style="background: #4CAF50; font-size: 0.7rem; padding: 4px 8px;" 
                                onclick="adminGiveMoneyToPlayer('${playerId}')">
                            💰
                        </button>
                        <button class="action-button" style="background: #FF9800; font-size: 0.7rem; padding: 4px 8px;" 
                                onclick="adminGiveCharacterToPlayer('${playerId}')">
                            🎭
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function adminGiveMoney() {
            const amount = parseInt(document.getElementById('adminMoney').value);
            if (!amount || amount <= 0) {
                showNotification('Digite uma quantidade válida!', 'warning');
                return;
            }
            
            gameState.money += amount;
            updateDisplay();
            showNotification(`👑 Admin deu $${amount} para você!`, 'success');
            document.getElementById('adminMoney').value = '';
        }

        function adminSpawnCharacter() {
            const charName = document.getElementById('adminCharacter').value;
            if (!charName) {
                showNotification('Selecione um personagem!', 'warning');
                return;
            }
            
            // Add to both inventory and base
            if (gameState.inventory[charName]) {
                gameState.inventory[charName]++;
            } else {
                gameState.inventory[charName] = 1;
            }
            
            if (gameState.base[charName]) {
                gameState.base[charName]++;
            } else {
                gameState.base[charName] = 1;
            }
            
            calculateIncome();
            updateInventoryDisplay();
            updateBaseDisplay();
            updateDisplay();
            
            showNotification(`👑 Admin spawnou ${charName}!`, 'success');
        }

        function adminGiveMoneyToPlayer(playerId) {
            const amount = parseInt(document.getElementById('adminMoney').value);
            if (!amount || amount <= 0) {
                showNotification('Digite uma quantidade no campo de dinheiro!', 'warning');
                return;
            }
            
            if (playerId === multiplayerState.playerId) {
                adminGiveMoney();
                return;
            }
            
            const player = roomPlayers[playerId];
            showNotification(`👑 Admin tentou dar $${amount} para ${player.name} (funcionalidade limitada)`, 'info');
        }

        function adminGiveCharacterToPlayer(playerId) {
            const charName = document.getElementById('adminCharacter').value;
            if (!charName) {
                showNotification('Selecione um personagem primeiro!', 'warning');
                return;
            }
            
            if (playerId === multiplayerState.playerId) {
                adminSpawnCharacter();
                return;
            }
            
            const player = roomPlayers[playerId];
            showNotification(`👑 Admin tentou dar ${charName} para ${player.name} (funcionalidade limitada)`, 'info');
        }

        async function adminRefreshBelt() {
            const newBelt = generateNewBelt();
            await saveSharedBelt(newBelt);
            await initializeBelt();
            showNotification('👑 Admin gerou nova esteira!', 'success');
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        // Override minigame click for admin challenge
        function minigameClick() {
            if (!minigameActive) return;
            
            const button = document.getElementById('minigameButton');
            if (!button.classList.contains('active')) return;
            
            if (adminState.adminChallengeActive) {
                clearTimeout(adminState.adminChallengeTimer);
                adminState.adminChallengeSuccess++;
                
                button.className = 'minigame-button';
                button.disabled = true;
                
                document.getElementById('minigameTimer').textContent = 'PERFEITO!';
                document.getElementById('minigameProgress').style.width = `${(adminState.adminChallengeSuccess / 5) * 100}%`;
                
                setTimeout(() => {
                    if (minigameActive) nextAdminChallengeRound();
                }, 600);
                
                return;
            }
            
            // Regular minigame logic
            clearTimeout(minigameTimer);
            minigameSuccess++;
            
            button.className = 'minigame-button';
            button.disabled = true;
            
            document.getElementById('minigameTimer').textContent = 'Acertou!';
            document.getElementById('minigameProgress').style.width = `${(minigameSuccess / 3) * 100}%`;
            
            setTimeout(() => {
                if (minigameActive) nextMinigameRound();
            }, 800);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            saveUserData();
            if (connectionInterval) {
                clearInterval(connectionInterval);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a2638510801b11',t:'MTc1NzA0MDMwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
